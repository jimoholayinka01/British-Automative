```{r}
#Web Scrapping Script
```


```{r}
# Install required libraries
install.packages("RSelenium")
install.packages("netstat")
install.packages("wdman")
install.packages("rvest")
install.packages("tidyverse")
install.packages("dplyr")
install.packages("httr")
install.packages("corrplot")
```
```{r}
# Load required libraries
library(RSelenium)
library(netstat)
library(tidyverse)
library(wdman)
library(rvest)
library(httr)
library(dplyr)
library(stringr)
library(readr)
library(corrplot)
library(tidyr)
```

```{r}
# Initialisation of an empty dataframe.
car_datas <- data.frame(
  brand = character(),
  model = character(),
  year = character(),
  mileage = character(),
  engine = character(),
  price = character(),
  stringsAsFactors = FALSE
)
```
```{r}
# Looping through the first 10 pages of the car website to scrape the html component
for (i in 1:10) {
  url <- paste0("https://www.thecarco.co.uk/used-cars/",i)
   # Read webpage
  webpages <- read_html(url)
  # Extract brand name
  brands <- html_nodes(webpages, ".landing-listing__makemodel") %>% html_text(trim = TRUE)
  # Extract car model
  models <- html_nodes(webpages, ".model") %>% html_text(trim = TRUE)
  # Extract car prices
  prices <- html_nodes(webpages, ".landing-listing__price .price") %>% html_text(trim = TRUE)
  # Extract engine type
  c_details <- html_nodes(webpages, ".landing-listing__trim") %>% html_text(trim = TRUE)
  engines <- sapply(c_details, function(x) strsplit(x, " ")[[1]][1])
  #Extract car specifications
  car_specs <- html_nodes(webpages, ".landing-listing__spec") %>% html_text(trim = TRUE)
  # Extract year and mileage
  car_years <- sapply(car_specs, function(x) ifelse(length(strsplit(x, " ")[[1]]) >= 1, strsplit(x, "\n")[[1]][1], NA))
  mileages <- sapply(car_specs, function(x) ifelse(length(strsplit(x, " ")[[1]]) >= 2, strsplit(x, "\n")[[1]][2], NA))
  # Creating a temporary dataframe
  temp_data <- data.frame(
    brand = brands,
    model = models,
    year = car_years,
    mileage = mileages,
    engine = engines,
    price = prices,
    stringsAsFactors = FALSE,
    row.names = NULL
  )
  # Append to main dataframe
  car_datas <- bind_rows(car_datas, temp_data)
}
# View the collected data
view(car_datas)
```
```{r}
#Dowloading all Selenium dependancies
selenium(version =  "3.141.59")
selenium_obj <- selenium(retcommand = T, check = F, version =  "3.141.59")
```
```{r}
# Starting RSelenium 
rs_driver_object <- rsDriver(browser = "firefox",
                         verbose = F,
                         chromever = NULL,
                         port = free_port(), version =  "3.141.59")
```


```{r}
#Opening the url link from the client side
remDR <- rs_driver_object$client
remDR$open
remDR$navigate("https://www.autotrader.co.uk/car-search?postcode=M6%205QD&homeDeliveryAdverts=include&advertising-location=at_cars&page=1")
```
```{r}
#Reading the html page
page_source <- remDR$getPageSource()[[1]]
page_html <- read_html(page_source)
pg_title <- page_html %>% html_nodes(".eDCaxo") %>% html_text()
pg_mile <- page_html %>% html_nodes("li.dUUmL") %>% html_text()
```
```{r}
  #Setting values for handling null or missing data
  min_length <- min(length(pg_title), length(mileages), length(year))
  # Extraction of the brand name, model and prices
  brands_1 = sapply(pg_title, function(x) trimws(strsplit(x, " ")[[1]][1]))
  models_1 = sapply(pg_title, function(x) trimws(strsplit(x, " ")[[1]][2]))
  prices_1 = sapply(pg_title, function(x) tail(strsplit(x, " ")[[1]], 1))
  #Extraction of the year the car was manufactured from the html page
  mileages_1 <- pg_mile[seq(1, length(pg_mile), by = 2)] %>% 
  gsub(" miles", "", .) %>% gsub(",", "", .)
  #Extraction of Mileages of the car from the html page
  car_year_1 <- pg_mile[seq(2, length(pg_mile), by = 2)] %>% 
  gsub(" .*", "", .)
  engines_1 <- character()
  #Handling null datas in the dataframe
  min_length <- min(length(pg_title), length(mileages_1), length(car_year_1))
  pg_title <- pg_title[1:min_length]
  mileages_1 <- mileages_1[1:min_length]
  car_year_1 <- car_year_1[1:min_length]
# Combination of the extracted data into a dataframe
  temp_data1 <- data.frame(
    brand = brands_1,
    model = models_1,
    year = car_year_1,
    mileage = mileages_1,
    price = prices_1,
    stringsAsFactors = FALSE,
    row.names = NULL
  )
  # Appending the data to main dataframe
  car_datas <- bind_rows(car_datas, temp_data1)
# View the collected data
view(car_datas)
```

```{r}
#Looping through the first 8 pages of the website
for (i in 1:8){
url = paste0("https://www.motorpoint.co.uk/used-cars?Page=",i)
webpages <- read_html(url)
#Extraction of the title page and the text of the html webpage
brand <- html_nodes(webpages, ".title") %>% html_text()
# Extraction of the brand name
brand_2 <- trimws(sapply(strsplit(brand, " "), `[`, 1))
# Extraction of the car models
model_2 <- trimws(sapply(strsplit(brand, " "), function(x) x[length(x)-1]))
#Extraction of the div container containing the year
year <- html_nodes(webpages, ".primary-details") %>% html_text()
# Extraction of the year the car was produced
year_2 <- trimws(sapply(strsplit(year, "\\|"), `[`, 1))
# Extraction of the car mileage
mileage_2 <- trimws(sapply(strsplit(year, "\\|"), function(x) tail(x, 1)))
#Extraction of the car price
price_2 <- html_nodes(webpages, ".price-text") %>% html_text()
#Extraction of the car engine horse power
horse_power_2 <- html_nodes(webpages, ".sub-title") %>% html_text()
# Extraction of the engine type
engine_2 <- trimws(sapply(strsplit(horse_power_2, " "), `[`, 1))
#Handling columns with missing values while scraing
min_len <- min(length(brand_2), length(model_2), length(mileage_2), length(year_2), length(price_2), length(engine_2))
# Creation of a temporary dataframe for the extracted data
temp_data2 <- data.frame(
  brand = brand_2[1:min_len],
  model = model_2[1:min_len],
  year = year_2[1:min_len],
  mileage = mileage_2[1:min_len],
  engine = engine_2[1:min_len],
  price = price_2[1:min_len]
)
# Binding the temporary dataframe with the existing dataframe
car_datas <- bind_rows(car_datas, temp_data2)
view(car_datas)
}

```
```{r}
#DATA CLEANING PROCESS
#CLEANING THE BRAND COLUMN TO REMOVE DOUBLE SPACES
car_datas$brand <- str_trim(str_replace_all(car_datas$brand, "\\s+", " "))
#FILTERS ONLY THE BRAND NAME BY EXTRACTING ONLY THE FIRST WORD IN THE BRAND COLUMN 
car_datas$brand <- word(car_datas$brand, 1)
#DUE TO THE NATURE OF THE DATASET TO CLEAN THE MILEAGE COLUMN WE NEED TO DIVIDE THE DATASET INTO TWO
car_data1 <- car_datas[1:282, ]
car_data2 <- car_datas[283:nrow(car_datas), ]
#CLEANING CAR_DATA2

#CLEANING MILEAGE COLUMN IN CAR_DATA2
#Extract the part after '|' (ignoring the reg details)
car_data2$mileage <- str_extract(car_data2$mileage, "(?<=\\| ).*")
#Remove the miles and (,) then we convert it to numeric 
car_data2$mileage <- as.numeric(str_replace_all(car_data2$mileage, "[^0-9]", ""))
#Extract only the four-digit year (before '(') 
car_data2$year <- str_extract(car_data2$year, "^\\d{4}") 
#convert year column to numeric
car_data2$year <- as.numeric(car_data2$year)
#extract only numeric values from engine  column and convert to numeric
car_data2$engine <- str_extract(car_data2$engine, "[0-9]+\\.?[0-9]*")
car_data2$engine <- as.numeric(car_data2$engine)
#convert values into standard KW, this is done by multiplying values less than 10 by 100
car_data2$engine <- ifelse(car_data2$engine < 10, car_data2$engine * 100, car_data2$engine)
#Remove the pound sign from the price column
car_data2$price <- as.numeric(str_replace_all(car_data2$price, "£|,", ""))
#Replace values that is a number in model column with NA
car_data2$model <- ifelse(str_detect(car_data2$model, "^\\d+$"), NA, car_data2$model)

#CLEANING CAR_DATA1

#extract only numeric values in the engine column
car_data1$engine <- str_extract(car_data1$engine, "[0-9]+\\.?[0-9]*")
##Extract only the four-digit values in the mileage column for rows containing values with '('
car_data1$mileage <- ifelse(str_detect(car_data1$mileage, "^\\d{4} \\("), 
                     str_extract(car_data1$mileage, "^\\d{4}"), 
                     car_data1$mileage)
#Replace rows that has value "Brand new" with "2025" in the mileage column
car_data1$mileage <- ifelse(str_to_lower(car_data1$mileage) == "brand new", "2025", car_data1$mileage)
#remove "," from values in the Mileage column
car_data1$mileage <- str_replace_all(car_data1$mileage, ",", "")
#Convert mileage column data type to numeric
car_data1$mileage <- as.numeric(car_data1$mileage)
#Remove commas "," from year column
car_data1$year <- str_replace_all(car_data1$year, ",", "")
#Replace non-numeric values with NA in the year column
car_data1$year <- ifelse(str_detect(car_data1$year, "[a-zA-Z]"), NA, car_data1$year)
#Convert year data type to numeric
car_data1$year <- as.numeric(car_data1$year)
#Convert columns to character to avoid conversion issues
car_data1$year <- as.character(car_data1$year)
car_data1$mileage <- as.character(car_data1$mileage)
#misplaced mileage values in the "year" column should be identified Mileage values are usually 5+ digits, OR 4 digits but not a valid year (not between 1900-2025)
misplaced_mileage <- !is.na(car_data1$year) & str_detect(car_data1$year, "^\\d{4,}$") & (!between(as.numeric(car_data1$year), 1900, 2025) | nchar(car_data1$year) > 4)
#misplaced year values in the "mileage" column are identified Year values are 4-digit numbers within the valid range (1900-2025)
misplaced_year <- !is.na(car_data1$mileage) & str_detect(car_data1$mileage, "^\\d{4}$") & between(as.numeric(car_data1$mileage), 1900, 2025)
#swap values where necessary
car_data1$temp <- car_data1$year
# Move year values to the correct column
car_data1$year[misplaced_mileage] <-
car_data1$mileage[misplaced_mileage] 
#Move mileage values to the correct column
car_data1$mileage[misplaced_year] <- car_data1$temp[misplaced_year]
#Remove temporary column
car_data1$temp <- NULL 

#Checking for outliers in the mileage column
boxplot(as.numeric(car_data1$mileage), main = "Mileage Distribution", col = "lightblue")
str(car_data1)
#Replace NA values in the mileage column with the median
car_data1$mileage[is.na(car_data1$mileage)] <- median(car_data1$mileage, na.rm = TRUE)
#Convert engine column to numeric
car_data1$engine <- as.numeric(car_data1$engine)
#convert values in the engine column into standard KiloWatt
car_data1$engine <- ifelse(car_data1$engine < 10, car_data1$engine * 100, car_data1$engine)
#Replace the NA values in the engine column with the median
car_data1$engine[is.na(car_data1$engine)] <- median(car_data1$engine, na.rm = TRUE)
#Remove pound sign and "," from the price column
car_data1$price <- as.numeric(str_replace_all(car_data1$price, "£|,", ""))
#Converting the mileage and year column to numeric
car_data1$mileage <- as.numeric(car_data1$mileage)
car_data1$year <- as.numeric(car_data1$year)

#JOIN BOTH DATASET
car_datan <- bind_rows(car_data1, car_data2)
View(car_datan)

#Save dataset into a csv file
write.csv(car_datan, "car_datan.csv", row.names= FALSE)

#DOING THE EDA


#Summarise the dataset
summary(car_datan)
#Count missing values
colSums(is.na(car_datan))

#PLot histograms for numeric variable

par(mfrow = c(2,2))
hist(car_datan$year, col = "skyblue", main = "Distribution of Car Year", xlab = "Year", breaks = 25)
hist(car_datan$mileage, col = "lightcoral", main = "Distribution of Mileage", xlab = "Mileage", breaks = 20)
hist(car_datan$engine, col = "lightgreen", main = "Distribution of Engine Power", xlab = "Engine Size", breaks = 15)
hist(car_datan$price, col = "gold", main = "Distribution of Car Price", xlab = "Price", breaks = 20)

#Get the top car brands
top_brands <- car_datan %>% count(brand, sort = TRUE) %>% head(10)

#plot ggplot of the top brands
ggplot(top_brands, aes(x = reorder(brand, -n), y = n, fill = brand)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(title = "Top 10 Most Common Car Brands", x = "Brand", y = "Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

#Correlation matrix
numeric_vars <- car_datan %>% select(where(is.numeric))
corr_matrix <- cor(numeric_vars, use = "complete.obs")

#PLot correlation heatmap
corrplot(corr_matrix, method = "color", addCoef.col = "black", tl.col = "black", tl.srt = 45)

#Boxplot to detect outliers
par(mfrow = c(1,3))
boxplot(car_datan$year, main = "Boxplot of Car Year", col = "skyblue")
boxplot(car_datan$mileage, main = "Boxplot of Mileage", col = "lightcoral")
boxplot(car_datan$price, main = "Boxplot of Car Price", col = "gold")

```



